from flask import Flask, request, redirect, url_for, make_response
from hashlib import sha256
from random import getrandbits
from os import urandom
from binascii import unhexlify, hexlify
from time import time
from struct import pack, unpack
import re

def i2b(i):
    x = hex(i)[2:]
    if len(x) % 2:
        x = '0' + x
    return bytes.fromhex(x)

def b2i(b):
    return int(hexlify(b), 16)

def modexp(base, exp, mod):
    r = 1
    base %= mod
    while exp > 0:
        if exp % 2:
            r = r * base % mod
        exp >>= 1
        base = base * base % mod
    return r

def pkcs1Pad(m, k):
    m = i2b(m)
    l = k - 3 - len(m)
    assert l >= 8
    return b2i(b'\x00\x01' + b'\xff' * l + b'\x00' + m)

def rsaEncrypt(m, e, n):
    k = len(i2b(n))
    return modexp(pkcs1Pad(m, k), e, n)

def rsaVerifySig(s, m, e, n, h = sha256):
    paddedHash = b'\x00' + i2b(modexp(s, e, n))
    mHash = h(i2b(m)).digest()
    print(paddedHash)
    print(mHash)
    return re.match(b'\x00\x01\xff*\x00' + re.escape(mHash), paddedHash) != None

secret = (None, 0)

def getSecret():
    global secret
    if not secret[0] or secret[1] + 1800 < time():
        secret = (getrandbits(256), time())
    return secret[0]

sig = 123
e = 3
n = 21427199614018908391066362188787527068531954512869999670245979924831782582989218085570947493166277318514705360665945294320779901567848185556940564122919200996033577438952955641278695668467747049674278272953660714367642563255667342358575961919807137159915737399104257392424985480723824487401037377539045626263808877384541765828169470839239068051800080964445011498529448953055555888234120736779103711893363607695851000243277051599216024419470438279688009975346943695285127185380975930454301334607429404943545234944013064456278636067965029274197765996767318856416888348009209936380417855720766426892873860280944967198621
secretMessage = 20399336875095081103245545055763027849641818269971185230814473699516101353913178185020107643434283419086053081491817722492260740397592460335785951251034986752495711683700364403016421194691066089078395966107009099632258973386499282532506372797035542259737663441499091306701028098991888815584373793890081050813318442375768050304793905436276660555230015170452975897390475918433058376690262029204455973062795555524763101794172491826903746925880551818028269222705643977354274239947766304617423465954748200511767651679554072218094675218584719107329470723474207389085401634735279930632770922356201173029156284017963641568513
print(rsaVerifySig(sig, getSecret(), e, n))
